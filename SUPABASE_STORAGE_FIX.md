# Supabase Storage - Signature Verification Fix

**Issue**: `StorageApiError: signature verification failed (status: 400)`

## Root Cause Analysis

The signature verification error occurs because the `SUPABASE_SERVICE_ROLE_KEY` in your `.env` file is **not the actual service role key** from your Supabase project. While the JWT structure is valid, it was not signed with the correct JWT secret that your Supabase project is currently using.

### Evidence

1. ‚úÖ JWT decodes correctly and shows valid structure:
   - Role: `service_role`
   - Project: `ajpkqayllmdzytrcgiwg`
   - Not expired (valid until 2035)

2. ‚ùå All Supabase API calls fail with signature verification:
   - Storage API: 403 Unauthorized
   - Auth API: 401 Unauthorized
   - This confirms the key is **not recognized** by Supabase

### Most Likely Causes

1. **Key was manually created/edited** - The key in `.env` appears to be a valid JWT but wasn't generated by your Supabase project
2. **JWT Secret rotated** - Supabase project's JWT secret was changed after this key was created
3. **Wrong project** - Key is from a different Supabase project (though the `ref` matches)

## How to Fix

### Step 1: Get the Correct Service Role Key

1. **Go to your Supabase Dashboard**:
   - Visit: https://supabase.com/dashboard/project/ajpkqayllmdzytrcgiwg/settings/api
   - Or navigate to: Project Settings ‚Üí API

2. **Locate the Service Role Key**:
   - Look for section "Project API keys"
   - Find the key labeled **"service_role secret"** (NOT the anon/public key)
   - Click the "eye" icon to reveal the key
   - Copy the **entire** key (it should start with `eyJ...`)

3. **Important**: Make sure you're copying the `service_role` key, not:
   - ‚ùå `anon` key (public, limited permissions)
   - ‚ùå `public` key (same as anon)

### Step 2: Update Your .env File

Replace the current `SUPABASE_SERVICE_ROLE_KEY` value in your `.env` file:

```bash
# Before (INCORRECT KEY):
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFqcGtxYXlsbG1kenl0cmNnaXdnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MDY0Mzg1MywiZXhwIjoyMDY2MjE5ODUzfQ.nJOH7DpgxJpQKyQEpQvvPPgXSEOTUPjJ4IZHdGDbhTA

# After (CORRECT KEY from Supabase Dashboard):
SUPABASE_SERVICE_ROLE_KEY=<paste_the_actual_key_from_dashboard>
```

### Step 3: Verify the Fix

Run the test script to verify the new key works:

```bash
node test-storage-auth.js
```

Expected output:
```
‚úÖ Standard client works! Buckets: X
‚úÖ Auth-disabled client works! Buckets: X
‚úÖ Direct API call works! Buckets: X
‚úÖ Auth API is working
```

### Step 4: Restart the Development Server

```bash
# Kill the current server (Ctrl+C or kill the process)
npm run dev
```

Expected output (NO errors):
```
‚úÖ Storage bucket already exists: bloggen-assets
```

Or:
```
‚úÖ Storage bucket created: bloggen-assets
```

## Verification Checklist

After updating the key, verify these work:

- [ ] `node test-storage-auth.js` - All tests pass
- [ ] `npm run dev` - Server starts without "signature verification failed" error
- [ ] Storage bucket is created or already exists
- [ ] Image upload functionality works (test article generation with images)

## Alternative: If Storage is Not Enabled

If you get the correct service role key and it still doesn't work, Storage might not be enabled in your Supabase project:

1. **Check Storage Status**:
   - Go to: https://supabase.com/dashboard/project/ajpkqayllmdzytrcgiwg/storage/buckets
   - If you see "Storage is not enabled" or similar message, you need to enable it

2. **Enable Storage** (if needed):
   - In Supabase Dashboard, go to Storage section
   - Click "Enable Storage" or "Activate"
   - Wait for Storage to be provisioned (~1-2 minutes)

## Impact on Application

### Current State (Without Fix)

- ‚ö†Ô∏è **Image uploads will fail** - Articles generated with images won't store images properly
- ‚ö†Ô∏è **Existing uploaded images won't be accessible** - If any images were uploaded before, they may not load
- ‚úÖ **Application still runs** - Database and API functionality work normally
- ‚úÖ **Article generation without images works** - Text-only articles function correctly

### After Fix

- ‚úÖ **Site-specific storage buckets** - Each site gets its own dedicated storage bucket (`site-{siteId}`)
- ‚úÖ **Image upload works** - DALL-E generated images are uploaded to Supabase Storage
- ‚úÖ **Image variants** - Multiple sizes (hero, social, thumbnail) generated automatically
- ‚úÖ **Public URLs** - Images accessible via CDN URLs

## Testing Storage After Fix

### Manual Test

1. Create an article with an image through the UI
2. Check that the image displays correctly
3. Verify the image URL is a Supabase Storage URL (format: `https://{project}.supabase.co/storage/v1/object/public/site-{id}/...`)

### Automated Test

```bash
# Test bucket creation
node test-supabase-storage.js

# Should output:
‚úÖ Successfully listed buckets
‚úÖ bloggen-assets bucket exists
‚úÖ Successfully created site bucket: site-test-{timestamp}
‚úÖ Test bucket deleted
‚úÖ Successfully uploaded test file
‚úÖ Public URL: https://...
‚úÖ Test file deleted
‚úÖ All storage tests completed successfully!
```

## Site-Specific Storage Architecture

Once storage is working, the application uses this structure:

### Bucket Naming
- **General assets**: `bloggen-assets` - Shared assets, deprecated
- **Site-specific**: `site-{site-uuid}` - Each site gets its own bucket

### Benefits
1. **Isolation**: Each site's images are in a separate bucket
2. **Access control**: Easier to manage permissions per site
3. **Storage limits**: Can set limits per site
4. **Cleanup**: Deleting a site deletes its bucket
5. **Multi-tenancy**: Clear separation of tenant data

### File Structure Within Buckets

```
site-{site-id}/
‚îú‚îÄ‚îÄ images/
‚îÇ   ‚îú‚îÄ‚îÄ {timestamp}-{filename}.webp
‚îÇ   ‚îú‚îÄ‚îÄ {timestamp}-{filename}.jpeg
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ sites/
‚îÇ   ‚îî‚îÄ‚îÄ {site-id}/
‚îÇ       ‚îú‚îÄ‚îÄ {post-id}/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ hero-{variant}.webp
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ social-{variant}.jpeg
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ thumb-{variant}.webp
‚îÇ       ‚îî‚îÄ‚îÄ general/
‚îÇ           ‚îî‚îÄ‚îÄ ...
```

## Troubleshooting

### Still Getting Signature Error After Update?

1. **Verify you copied the entire key** - No spaces, no truncation
2. **Check for extra quotes** - The key should not have quotes around it in `.env`
3. **Restart the server** - Environment variables are only loaded at startup
4. **Clear any cached env vars** - `unset SUPABASE_SERVICE_ROLE_KEY` then restart

### Storage API Returns 404?

- Storage might not be enabled in your Supabase project
- Go to Dashboard ‚Üí Storage and enable it

### Different Error Now?

- Share the new error message
- Run `node check-jwt.js` to verify the new key structure
- Check Supabase Dashboard for any service disruptions

## Security Notes

### DO NOT Commit Service Role Key

The `.env` file is already in `.gitignore`. Make sure:

```bash
# Verify .env is ignored
git check-ignore .env
# Should output: .env

# If not, add it:
echo ".env" >> .gitignore
```

### Service Role Key Permissions

The service role key has **FULL ACCESS** to your Supabase project:
- ‚úÖ Use it only in backend code (server-side)
- ‚ùå Never expose it to frontend/client code
- ‚ùå Never commit it to version control
- ‚ùå Never share it publicly

The frontend should use the `VITE_SUPABASE_ANON_KEY` which has restricted permissions via Row Level Security policies.

## Next Steps After Fix

1. ‚úÖ Update service role key in `.env`
2. ‚úÖ Verify storage tests pass
3. ‚úÖ Restart development server
4. ‚úÖ Test article generation with images
5. ‚úÖ Verify images display correctly
6. ‚úÖ Check site-specific buckets are created
7. üìù Update production environment variables when deploying

## Related Files

- [.env](.env) - Environment configuration (needs update)
- [server/lib/supabaseStorage.ts](server/lib/supabaseStorage.ts) - Storage implementation
- [test-storage-auth.js](test-storage-auth.js) - Storage testing script
- [test-supabase-storage.js](test-supabase-storage.js) - Comprehensive storage test
- [check-jwt.js](check-jwt.js) - JWT validation tool

---

**Last Updated**: October 31, 2025
**Status**: ‚ö†Ô∏è Awaiting Correct Service Role Key
**Severity**: Medium (Images don't work, but app functions otherwise)
